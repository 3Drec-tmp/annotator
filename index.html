<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="style.css">
    <title>FVApp Annotator</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">


    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script src="./fabric.min.js"></script>
    <script src="./jquery-3.5.1.min.js"></script>
    <script src="./fv-annotate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
  
        let imagesArray = []
        var anotation_tool = null;
        var satellite_tool = null;
        var active_img = null;
        var active_sat_img_name = null;

        const url = "http://147.32.71.74:443/api/insert_annotation"

        function sendToCanvas(index) {
            console.log(imagesArray[index])
            active_img = imagesArray[index]

            container = document.getElementById("canvas_main");
            container.innerHTML = '';
            container.innerHTML = `<canvas id="canvas_img" style="border:1px solid black;"></canvas>`
            containerz = document.getElementById("canvas_zoom");
            containerz.innerHTML = '';
            containerz.innerHTML = `<canvas id="zoom_win" width="400" height="200" style="display:none;position:absolute;top:0;left:0;border:1px solid black;"></canvas>
`

            anotation_tool = new AnotationCanvas('canvas_img' , URL.createObjectURL(imagesArray[index]), 820);
            anotation_tool.init();
            anotation_tool.init_zoom();
            console.log(anotation_tool)

            if (satellite_tool != null) {
                if (!confirm('Does satellite image matche?')) {
                    requestSat();
                }   
            }
        }

        function displayImageList(output) {
            let images = ""
            
            imagesArray.forEach((image, index) => {
                images += `<div>
                            <button type="button" class="btn btn-outline-dark btn-small" onclick="sendToCanvas(${index})">
                                "${image.name}"
                            </button>
                            
                            </div>`
            })
            output.innerHTML = images
        }

        function pixelToLatLon(zoomLevel, startLat, startLon, dxPixels, dyPixels) {
            const spatialResolution = (156543.03392 * Math.cos(startLat * Math.PI / 180)) / Math.pow(2, zoomLevel);

            console.log(spatialResolution)
            const earthRadius = 6378137; // Earth's radius in meters (approximate)

            const dxMeters = dxPixels * spatialResolution;
            const dyMeters = dyPixels * spatialResolution;

            const dLat = dyMeters / earthRadius * 180 / Math.PI;
            const dLon = dxMeters / earthRadius * 180 / Math.PI / Math.cos(startLat * Math.PI / 180);

            const endLat = startLat + dLat;
            const endLon = startLon + dLon;

            return [endLat, endLon];
        }


        function deleteImage(index) {
            imagesArray.splice(index, 1)
            displayImagesList()
        }
        
        function dmsToDecimal(degs, mins, secs, direction) {
            let sign = 1;
            if (direction == 'S' || direction == 'W') {
                sign = -1;
            }
            return sign * (Math.abs(degs) + mins/60 + secs/3600);
        }

        function requestSat() {
            if (anotation_tool == null) {
                alert("You have to load image first")
                return
            }

            EXIF.getData(active_img, function () {
                    var MetaData = EXIF.getAllTags(this);
                    console.log(JSON.stringify(MetaData, null, "\t"));
                    if (!('GPSLatitude' in MetaData) || !('GPSLongitude' in MetaData)){
                        alert("No location data found, cant get the satellite image.")
                        return
                    }
                    var coordLat = dmsToDecimal(...MetaData['GPSLatitude'], MetaData['GPSLatitudeRef'])
                    var coordLon = dmsToDecimal(...MetaData['GPSLongitude'], MetaData['GPSLongitudeRef'])
                    if (!(typeof coordLat === 'undefined') && !(typeof coordLon == 'undefined')){
                        requestDist([coordLat, coordLon])
                    } else {
                        alert("No location data found, cant get the satellite image.")
                    }
                }
            );
            
        }

        function sendSatRequest(data, success_fun){
            $.ajax({
                url: "http://147.32.71.74:443/api/request_satelite_image",
                type: "GET",
                CORS:true,
                headers: {
                    'Access-Control-Allow-Origin': '*',
                },
                data: data,
                xhr:function(){// Seems like the only way to get access to the xhr object
                    var xhr = new XMLHttpRequest();
                    xhr.responseType= 'blob'
                    return xhr;
                },
                success: success_fun,
                error: function (data) {
                    console.log(data);
                    alert("Error occured, try again")
                }
            });
        }


        function requestZoomed(new_coords) {
            console.log()
            data = {
                    "lat": new_coords[0],
                    "lon": new_coords[1],
                    "zoom": 20,
                    "img_name": new_coords.toString()+"_20.jpg"
            }

            success_fn = (data) => {
                console.log(data);
                container = document.getElementById("canvas_sec");
                container.innerHTML = '';
                container.innerHTML = `<canvas id="canvas_sat" style="border:1px solid black;"></canvas>`
                let satUrl = URL.createObjectURL(data);
                console.log(satUrl)
                satellite_tool = new AnotationCanvas('canvas_sat', satUrl, 820);
                satellite_tool.init();
                active_sat_img_name = new_coords.toString()+"_20.jpg"
            };
            sendSatRequest(data, success_fn)

        }
       
        function requestDist(coords) {
            var new_coords;
            data = {
                "lat": coords[0],
                "lon": coords[1],
                "zoom": 19,
                "img_name": coords.toString()+"_19.jpg"
            };
            success_fun = (data) => {
                console.log(data);
                var overlay = document.getElementById('overlay');
                overlay.style.display = "block";
                var img = document.getElementById('img');
                img.src = URL.createObjectURL(data);
                $("#img").on("click", (event) => {
                    console.log(event)
                    console.log(this)
                    var dx = event.originalEvent.layerX - event.target.width / 2;
                    var dy =  event.target.width / 2 - event.originalEvent.layerY ;
                    new_coords = pixelToLatLon(19, coords[0], coords[1],  dx, dy)
                    overlay.style.display = "none";
                    requestZoomed(new_coords)
                });
            };
            sendSatRequest(data, success_fun)
        }

        function sendAnnot() {
            if (anotation_tool == null || satellite_tool == null) {
                alert("You have to load image and satellite image first")
                return
            }
            if (anotation_tool.isEmpty() || satellite_tool.isEmpty()) {
                alert("You have to annotate image and satellite image first")
                return
            }
            if (confirm('Are you sure satellite image matches and you want to send the annotations?')) {
                // POST REQUEST TO SERVER ANNOTATIONS
                const formData = new FormData()
                formData.append('annot_pic', anotation_tool.get_annotation_obj())
                formData.append('img_pic', active_img)
                formData.append('img_pic_name', active_img.name)
                formData.append('img_pic_width', anotation_tool._original_img_shape[0])
                formData.append('img_pic_height', anotation_tool._original_img_shape[1])
                formData.append('annot_sat', anotation_tool.get_annotation_obj())
                formData.append('img_sat_name', active_sat_img_name)

                
                console.log(formData)
                console.log("sending annot");
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    CORS:true,
                    headers:{
                        'Access-Control-Allow-Origin': '*',
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(data => {
                    console.log(data)
                    // remove canvas and image from images
                    

                })
                .catch(error => {
                    console.error(error)
                });

            } 
        }
 
        document.addEventListener("DOMContentLoaded", function (event) {
     
            const fileSelector = document.getElementById("file-selector");
            const imageList = document.getElementsByClassName("image-list-content")[0];

            fileSelector.addEventListener('change', (event) => {
                const fileList = event.target.files;
                console.log(fileList);
                for (let i = 0; i < fileList.length; i++) {
                    imagesArray.push(fileList[i])
                
                }
                displayImageList(imageList)
            });

            

        });
        
    </script>

    <style type="text/css">
        .anot_class {
            float: left;
            width: 40px;
            height: 40px;
            margin: 5px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>Annotator for FVApp</h2>
        <p>If any problems occur, contact @fel.cvut.cz.</p>
    </div>

    <div class="content">
        <div class="navigation">
                <h3>Image loading</h3>
                <div class="form-group">
                    <label for="file-selector">Select image:</label>
                    <input type="file" multiple id="file-selector" name="file-selector" accept="image/*">
                </div>
                <div class="image-list">
                    <div>
                        <h4>Image list</h4>
                        <p> Then click on image in order to open it in canvas.</p>
                    </div>
                    <div class="image-list-content">
                        
                    </div>
                </div>
                <div class="sat">
                    <h3>Satellite image</h3>
                    <p>Request new satellite image corresponding to image on canvas</p>
                    <button type="button" class="btn btn-primary" onclick=requestSat()>
                        Get image
                    </button>
                </div>

                <h3>Anotation steps</h3>
                <p>1) Select the class</p>
                <p>2) Anotate the object on the image</p>
                <p>2a) After start editing controll points, new controll points are added to closest line segment</p>
                <p>2b) You can delete the points by Backspace or Delete in the order they were added</p>
                <p>3) You can add -> press "a" letter, a new polygon of the same class</p>
                <p>4) You can delete -> press two times "d" letter (to prevent unwanted delete) the active polygon of active class</p>
                <p>5) Switch between classes by pressing "Tab" on keyboard</p>
                <div class="classes_cont">
                    <div id="anot_class_000" style="background-color:red" class="anot_class">&nbsp;</div>
                    <div id="anot_class_001" style="background-color:blue" class="anot_class">&nbsp;</div>
                    <div id="anot_class_002" style="background-color:green" class="anot_class">&nbsp;</div>
                    <div id="anot_class_003" style="background-color:silver" class="anot_class">&nbsp;</div>
                    <div id="anot_class_004" style="background-color:yellow" class="anot_class">&nbsp;</div>
                </div>
        </div>
        <div class="canvases">
            <div id="canvas_main">
                <canvas id="canvas_img" style="border:1px solid black;"></canvas>
            </div>

            <div id="canvas_zoom">
                <canvas id="zoom_win" width="400" height="200" style="display:none;position:absolute;top:0;left:0;border:1px solid black;"></canvas>

            </div>

            <div id="canvas_sec">
                <canvas id="canvas_sat" style="border:1px solid black;"></canvas>
            </div>
            <div id="send_button">
                <button type="button" class="btn btn-dark" onclick=sendAnnot()>
                    Send annotation
                </button>
            </div>
           
        </div>
    </div>  

    <div id="overlay" class="overlay">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">
            
            <img id="img" width="600px">

            <h4 id="overlay_text" style="color:white">
                By clicking on the captured house, you confirm its position and close this screen.
            </h4>
        </div>

    </div>


</body>
</html>