<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="style.css">
    <title>FVApp Annotator</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">


    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script src="./fabric.min.js"></script>
    <script src="./jquery-3.5.1.min.js"></script>
    <script src="./fv-annotate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
  
        let imagesArray = []
        var anotation_tool = null;
        var satellite_tool = null;
        var active_img = null;
        var active_sat_img_name = null;
        var active_polygon_id = 0;

        const url = "http://147.32.71.74:443/api/insert_annotation"

        function setActiveAnnot(id) {
            if (anotation_tool != null) {
                anotation_tool.setActive(id===1);
            }
            if (satellite_tool != null) {
                satellite_tool.setActive(id===0);
            }
            if (id===1) {
                container = document.getElementById("canvas_main");
                container.style.border = "2px solid black";
                container = document.getElementById("canvas_sec");
                container.style.border = "0px solid black";
            } else {
                container = document.getElementById("canvas_main");
                container.style.border = "0px solid black";
                container = document.getElementById("canvas_sec");
                container.style.border = "2px solid black";
            }

        }

        function sendToCanvas(index) {
            console.log(imagesArray[index])
            active_img = imagesArray[index]

            container = document.getElementById("canvas_main");
            container.innerHTML = '';
            container.innerHTML = `<canvas id="canvas_img" style="border:1px solid black;"></canvas>`
            containerz = document.getElementById("canvas_main_zoom");
            containerz.innerHTML = '';
            containerz.innerHTML = `<canvas id="zoom_main_win" width="200" height="200" ></canvas>
`

            anotation_tool = new AnotationCanvas('canvas_img', "zoom_main_win" , URL.createObjectURL(imagesArray[index]), 900);
            anotation_tool.init(active_polygon_id);
            anotation_tool.init_zoom();

            if (satellite_tool != null) {
                if (!confirm('Does the loaded satellite image match with the new img?')) {
                    requestSat();
                }   
            }
        }

        function setActivePolygon(index) {
            active_polygon_id = index
            if (anotation_tool != null) {
                anotation_tool.changeActivePolygon(index)
            }
            if (satellite_tool != null) {
                satellite_tool.changeActivePolygon(index)
            }
        }

        function displayImageList(output) {
            let images = ""
            
            imagesArray.forEach((image, index) => {
                images += `<div>
                            <button type="button" class="btn btn-outline-dark btn-small" onclick="sendToCanvas(${index})">
                                "${image.name}"
                            </button>
                                <span onclick="deleteImage(${index})" style="cursor:pointer;">&times;</span>
                            </div>`
            })
            output.innerHTML = images
            
            if (anotation_tool == null) {
                sendToCanvas(0)
            }
        }

        function pixelToLatLon(zoomLevel, startLat, startLon, dxPixels, dyPixels) {
            const spatialResolution = (156543.03392 * Math.cos(startLat * Math.PI / 180)) / Math.pow(2, zoomLevel);

            console.log(spatialResolution)
            const earthRadius = 6378137; // Earth's radius in meters (approximate)

            const dxMeters = dxPixels * spatialResolution;
            const dyMeters = dyPixels * spatialResolution;

            const dLat = dyMeters / earthRadius * 180 / Math.PI;
            const dLon = dxMeters / earthRadius * 180 / Math.PI / Math.cos(startLat * Math.PI / 180);

            const endLat = startLat + dLat;
            const endLon = startLon + dLon;

            return [endLat, endLon];
        }


        function deleteImage(index) {
            console.log(index)
            imagesArray.splice(index, 1)

            imageList = document.getElementsByClassName("image-list-content")[0];
            displayImageList(imageList )
        }
        
        function dmsToDecimal(degs, mins, secs, direction) {
            let sign = 1;
            if (direction == 'S' || direction == 'W') {
                sign = -1;
            }
            return sign * (Math.abs(degs) + mins/60 + secs/3600);
        }

        function requestSat() {
            if (anotation_tool == null) {
                alert("You have to load image first")
                return
            }

            EXIF.getData(active_img, function () {
                    var MetaData = EXIF.getAllTags(this);
                    console.log(JSON.stringify(MetaData, null, "\t"));
                    if (!('GPSLatitude' in MetaData) || !('GPSLongitude' in MetaData)){
                        alert("No location data found, cant get the satellite image.")
                        return
                    }
                    var coordLat = dmsToDecimal(...MetaData['GPSLatitude'], MetaData['GPSLatitudeRef'])
                    var coordLon = dmsToDecimal(...MetaData['GPSLongitude'], MetaData['GPSLongitudeRef'])
                    if (!(typeof coordLat === 'undefined') && !(typeof coordLon == 'undefined')){
                        requestDist([coordLat, coordLon])
                    } else {
                        alert("No location data found, cant get the satellite image.")
                    }
                }
            );
            
        }

        function sendSatRequest(data, success_fun){
            $.ajax({
                url: "http://147.32.71.74:443/api/request_satelite_image",
                type: "GET",
                CORS:true,
                headers: {
                    'Access-Control-Allow-Origin': '*',
                },
                data: data,
                xhr:function(){// Seems like the only way to get access to the xhr object
                    var xhr = new XMLHttpRequest();
                    xhr.responseType= 'blob'
                    return xhr;
                },
                success: success_fun,
                error: function (data) {
                    console.log(data);
                    alert("Error occured, try again")
                }
            });
        }


        function requestZoomed(new_coords) {
            console.log()
            data = {
                    "lat": new_coords[0],
                    "lon": new_coords[1],
                    "zoom": 20,
                    "img_name": new_coords.toString()+"_20.jpg"
            }

            success_fn = (data) => {
                console.log(data);
                container = document.getElementById("canvas_sec");
                container.innerHTML = '';
                container.innerHTML = `<canvas id="canvas_sat" style="border:1px solid black;"></canvas>`
                containerz = document.getElementById("canvas_sec_zoom");
                containerz.innerHTML = '';
                containerz.innerHTML = `<canvas id="zoom_sec_win" width="200" height="200"></canvas>
    `
                let satUrl = URL.createObjectURL(data);
                console.log(satUrl)
                satellite_tool = new AnotationCanvas('canvas_sat', 'zoom_sec_win' ,satUrl, 820);
                satellite_tool.init(active_polygon_id);
                satellite_tool.init_zoom();
                active_sat_img_name = new_coords.toString()+"_20.jpg"
            };
            sendSatRequest(data, success_fn)

        }
       
        function requestDist(coords) {
            var new_coords;
            data = {
                "lat": coords[0],
                "lon": coords[1],
                "zoom": 19,
                "img_name": coords.toString()+"_19.jpg"
            };
            success_fun = (data) => {
                console.log(data);
                var overlay = document.getElementById('overlay');
                overlay.style.display = "block";
                var img = document.getElementById('img');
                img.src = URL.createObjectURL(data);
                $("#img").on("click", (event) => {
                    console.log(event)
                    console.log(this)
                    var dx = event.originalEvent.layerX - event.target.width / 2;
                    var dy =  event.target.width / 2 - event.originalEvent.layerY ;
                    new_coords = pixelToLatLon(19, coords[0], coords[1],  dx, dy)
                    overlay.style.display = "none";
                    requestZoomed(new_coords)
                });
            };
            sendSatRequest(data, success_fun)
        }

        function sendAnnot() {
            if (anotation_tool == null || satellite_tool == null) {
                alert("You have to load image and satellite image first")
                return
            }
            if (anotation_tool.isEmpty() || satellite_tool.isEmpty()) {
                alert("You have to annotate image and satellite image first")
                return
            }
            if (confirm('Are you sure satellite image matches and you want to send the annotations?')) {
                // POST REQUEST TO SERVER ANNOTATIONS
                const formData = new FormData()
                formData.append('annot_pic', anotation_tool.get_annotation_obj())
                formData.append('img_pic', active_img)
                formData.append('img_pic_name', active_img.name)
                formData.append('img_pic_width', anotation_tool._original_img_shape[0])
                formData.append('img_pic_height', anotation_tool._original_img_shape[1])
                formData.append('annot_sat', anotation_tool.get_annotation_obj())
                formData.append('img_sat_name', active_sat_img_name)

                
                console.log(formData)
                console.log("sending annot");
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    CORS:true,
                    headers:{
                        'Access-Control-Allow-Origin': '*',
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(data => {
                    console.log(data)
                    // remove canvas and image from images
                    

                })
                .catch(error => {
                    console.error(error)
                });

                const index = imagesArray.indexOf(active_img);
                deleteImage(index)
                anotation_tool.destroy_zoom()
                anotation_tool = null
                container = document.getElementById("canvas_main");
                container.innerHTML = '';
                container.innerHTML = `<canvas id="canvas_img" style="border:1px solid black;"></canvas>`

            } 
        }
 
        document.addEventListener("DOMContentLoaded", function (event) {
     
            const fileSelector = document.getElementById("file-selector");
            const imageList = document.getElementsByClassName("image-list-content")[0];

            fileSelector.addEventListener('change', (event) => {
                const fileList = event.target.files;
                console.log(fileList);
                for (let i = 0; i < fileList.length; i++) {
                    imagesArray.push(fileList[i])
                
                }
                displayImageList(imageList)
            });

        });
        
    </script>
</head>
<body>

    <div class="header">
        <h4>Annotator for SolAR</h4>
        <h6>If any problems occur, contact kafkaon1@fel.cvut.cz.</h6>
    </div>

    <div class="content">
        <div class="navigation">
            
                <div class="form-group">
                    <label for="file-selector">Load images</label>
                    <input type="file" multiple id="file-selector" name="file-selector" accept="image/*">
                </div>
                
                <div class="image-list-content">
                    <p><i>No loaded images yet.</i></p>
                </div>

                <div class="annotations">
                    <label>Annotation class</label>
                    <div class="classes_cont">
                        <input id=anot_class_1 name=classradios type=radio checked><label for=anot_class_1 onclick=setActivePolygon(0)> <div class="radio-label"> <p>Roof</p><div style="background-color:green;height:20px;width:20px;border-radius: 100px;"></div> </div></label>
                        <input id=anot_class_2 name=classradios type=radio><label for=anot_class_2 onclick=setActivePolygon(1)> <div class="radio-label"> <p>Window</p><div style="background-color:blue;height:20px;width:20px;border-radius: 100px;"></div> </div></label>
                        <input id=anot_class_3 name=classradios type=radio><label for=anot_class_3 onclick=setActivePolygon(2)> <div class="radio-label"> <p>Door</p><div style="background-color:purple;height:20px;width:20px;border-radius: 100px;"></div> </div></label>
                        <input id=anot_class_4 name=classradios type=radio><label for=anot_class_4 onclick=setActivePolygon(3)> <div class="radio-label"> <p>Chimney</p><div style="background-color:yellow;height:20px;width:20px;border-radius: 100px;"></div> </div></label>
                        <input id=anot_class_5 name=classradios type=radio><label for=anot_class_5 onclick=setActivePolygon(4)> <div class="radio-label"> <p>Other</p><div style="background-color:red;height:20px;width:20px;border-radius: 100px;"></div> </div></label>
                    </div>
                </div>
                <div class="info">
                    <label>Active label</label>
                    <p id="poly_label"></p>
                </div>
                <div class="info">
                    <label>Active mode</label>
                    <p id="mode">edit</p>
                </div>
                <div class="sat">
                    <label>Get Satellite image</label>
                    <button type="button" class="btn btn-primary" data-toggle="tooltip" data-placement="bottom" title="Request new satellite image corresponding to the image on canvas" onclick=requestSat()>
                        Get image
                    </button>
                </div>
                <div class="fin">
                    <label>Finish image pair</label>
                    <button type="button" class="btn btn-dark" data-toggle="tooltip" data-placement="bottom" title="If this annotation pair of your and sat. image is finished, you can send it" onclick=sendAnnot()>
                        Send annotation
                    </button>
                </div>

              
        </div>
        <div class="canvases">
            <div id="canvas_main" onclick=setActiveAnnot(1)>
                <canvas id="canvas_img" style="border:1px solid black;"></canvas>
            </div>

            <div id="canvas_sec" onclick=setActiveAnnot(0)>
                <canvas id="canvas_sat" style="border:1px solid black;"></canvas>
            </div>

            <div id="canvas_main_zoom">
                <canvas id="zoom_main_win" width="200" height="200"></canvas>
            </div>

            <div id="canvas_sec_zoom">
                <canvas id="zoom_sec_win" width="200" height="200"></canvas>
            </div>

        </div>
    </div>  
    <div class="footer">
    <h3>Anotation steps</h3>
    <p>1) Select the class</p>
    <p>2) Anotate the object on the image</p>
    <p>2a) After start editing control points, new controll points are added to closest line segment</p>
    <p>2b) You can delete the points by Backspace or Delete in the order they were added</p>
    <p>3) You can add -> press "a" letter, a new polygon of the same class</p>
    <p>4) You can delete -> press two times "d" letter (to prevent unwanted delete) the active polygon of active class</p>
    <p>5) Switch between classes by pressing "Tab" on keyboard</p>
    <p>6) Switch corner numbers using left and right arrow</p>

    </div>

    <div id="overlay" class="overlay">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">
            
            <img id="img" width="600px">
            <h4 id="overlay_text" style="color:white">
                By clicking on the captured house, you confirm its position and close this screen.
            </h4>
        </div>

    </div>


</body>
</html>