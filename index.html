<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="style.css">
    <title>FVApp Annotator</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">


    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script src="./fabric.min.js"></script>
    <script src="./jquery-3.5.1.min.js"></script>
    <script src="./fv-annotate.js"></script>

    <script>
        let imagesArray = []
        var anotation_tool = null;
        var satellite_tool = null;
        var active_img = null;
        var active_sat_img = null;

        function sendToCanvas(index) {
            console.log(imagesArray[index])
            active_img = imagesArray[index]

            url = URL.createObjectURL(imagesArray[index])

            container = document.getElementById("canvas_main");
            container.innerHTML = '';
            container.innerHTML = `<canvas id="canvas_img" style="border:1px solid black;"></canvas>`

            anotation_tool = new AnotationCanvas('canvas_img', URL.createObjectURL(imagesArray[index]), 820);
            anotation_tool.init();

            // if (satellite_tool != null) {
            //     if (confirm('Does satellite image matches?')) {
            //     // Save it!
            //     console.log('Thing was saved to the database.');
            //     } else {
            //     // Do nothing!
            //     console.log('Thing was not saved to the database.');
            //     }   
            // }
        }

        function displayImageList(output) {
            let images = ""
            imagesArray.forEach((image, index) => {
                images += `<div>
                            <button type="button" class="btn btn-outline-dark btn-small" onclick="sendToCanvas(${index})">
                                "${image.name}"
                            </button>
                            
                            </div>`
            })
            output.innerHTML = images
        }


        function deleteImage(index) {
            imagesArray.splice(index, 1)
            displayImagesList()
        }
        
        function getCoords(image) {
            let coords = [50.67315, 13.94149]
            EXIF.getData(image, function () {
                    var MetaData = EXIF.getAllTags(this);
                    console.log(JSON.stringify(MetaData, null, "\t"));
                }
            );
            return coords
        }


        function requestSat() {
            coords = getCoords(active_img)
            $.ajax({
                type: "GET",
                url: "http://10.35.161.7:443/api/save_request",
                data: {
                    "lat": coords[0],
                    "lon": coords[1],
                    "zoom": 19,
                },
            }).done(function (data) {
                data_obj = JSON.parse(data);
                console.log(data_obj);
                if (data_obj["status"] == "ok") {
                    console.log("ok")
                    container = document.getElementById("canvas_sat");
                    container.innerHTML = '';
                    container.innerHTML = `<canvas id="canvas_sat_img" style="border:1px solid black;"></canvas>`

                    satellite_tool = new AnotationCanvas('canvas_sat_img', data_obj["url"], 820);
                    satellite_tool.init();
                }
                else {
                    alert("Error occured, try again")
                }});

        }

        function sendAnnot() {
            if (anotation_tool == null || satellite_tool == null) {
                alert("You have to load image and satellite image first")
            }
            if (anotation_tool.isEmpty() || satellite_tool.isEmpty()) {
                alert("You have to annotate image and satellite image first")
            }
            if (confirm('Are you sure satellite image matches and you want to send the annotations?')) {
                // Save it!
                console.log("sending annot");
            }
        }
 
        document.addEventListener("DOMContentLoaded", function (event) {
            const fileSelector = document.getElementById("file-selector");
            const imageList = document.getElementsByClassName("image-list-content");

            console.log(imageList);
            fileSelector.addEventListener('change', (event) => {
                
                const fileList = event.target.files;
                console.log(fileList);
                for (let i = 0; i < fileList.length; i++) {
                    imagesArray.push(fileList[i])
                
                }
                displayImageList(imageList[0])
            });

        });
        
    </script>

    <style type="text/css">
        .anot_class {
            float: left;
            width: 40px;
            height: 40px;
            margin: 5px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>Annotator for FVApp</h2>
        <p>If any problems occur, contact @fel.cvut.cz.</p>
    </div>

    <div class="content">
        <div class="navigation">
                <h3>Image loading</h3>
                <div class="form-group">
                    <label for="file-selector">Select image:</label>
                    <input type="file" multiple id="file-selector" name="file-selector" accept="image/*">
                </div>
                <div class="image-list">
                    <div>
                        <h4>Image list</h4>
                        <p> Then click on image in order to open it in canvas.</p>
                    </div>
                    <div class="image-list-content">
                        
                    </div>
                </div>
                <div class="sat">
                    <h3>Satellite image</h3>
                    <p>Request new satellite image corresponding to image on canvas</p>
                    <button type="button" class="btn btn-primary" onclick=requestSat()>
                        Get image
                    </button>
                </div>

                <h3>Anotation steps</h3>
                <p>1) Select the class</p>
                <p>2) Anotate the object on the image</p>
                <p>2a) After start editing controll points, new controll points are added to closest line segment</p>
                <p>2b) You can delete the points by Backspace or Delete in the order they were added</p>
                <p>3) You can add -> press "a" letter, a new polygon of the same class</p>
                <p>4) You can delete -> press two times "d" letter (to prevent unwanted delete) the active polygon of active class</p>
                <p>5) Switch between classes by pressing "Tab" on keyboard</p>
        
        
                <div id="anot_class_000" style="background-color:red" class="anot_class">&nbsp;</div>
                <div id="anot_class_001" style="background-color:blue" class="anot_class">&nbsp;</div>
                <div id="anot_class_002" style="background-color:green" class="anot_class">&nbsp;</div>
                <div id="anot_class_003" style="background-color:silver" class="anot_class">&nbsp;</div>
                <div id="anot_class_004" style="background-color:yellow" class="anot_class">&nbsp;</div>
        </div>
        <div class="canvases">
            <div id="canvas_main">
                <canvas id="canvas_img" style="border:1px solid black;"></canvas>
            </div>

            <div id="canvas_sec">
                <canvas id="canvas_sat" style="border:1px solid black;"></canvas>
            </div>
            <div id="send_button">
                <button type="button" class="btn btn-dark" onclick=sendAnnot()>
                    Send annotation
                </button>
            </div>
        </div>
    </div>  




</body>
</html>